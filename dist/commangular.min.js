/**
 * Command pattern implementation for AngularJS
 * @version v0.9.0 - 2015-08-03
 * @link https://github.com/yukatan/commangular
 * @author Jesús Barquín Cheda <yukatan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";!function(a,b,c){function d(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function e(a,b){this.ctype=a,this.command=b,this.descriptors=[]}function f(a,c,d,e){this.contextData=a||{},this.contextData.commandModel={},this.currentDeferred,this.currentCommandInstance,this.canceled=!1,this.processDescriptor=function(a){switch(a.ctype){case"S":return this.processSequence(a);case"P":return this.processParallel(a);case"E":return this.processCommand(a);case"F":return this.processFlow(a)}},this.processSequence=function(a){var b=c.defer(),d=0,e=this;return function f(){e.processDescriptor(a.descriptors[d]).then(function(){return++d===a.descriptors.length?void b.resolve():void f()},function(a){b.reject(a)})}(),b.promise},this.processParallel=function(a){var d=this,e=c.defer(),f=0;return b.forEach(a.descriptors,function(b){d.processDescriptor(b).then(function(){++f===a.descriptors.length&&e.resolve()},function(a){e.reject(a)})}),e.promise},this.processFlow=function(a){var f=this,g=c.defer(),h=0;return function i(){var c={},j=a.descriptors[h];j.services&&b.forEach(j.services.split(","),function(a,b){c[a]=d.get(a)});var k=e(j.expresion)(f.contextData,c);if("boolean"!=typeof k)throw new Error("Result from expresion :"+a.expresion+" is not boolean");if(k)f.processDescriptor(j.commandDescriptor).then(function(){return++h===a.descriptors.length?void g.resolve():void i()},function(a){g.reject(a)});else{if(++h===a.descriptors.length)return void g.resolve();i()}}(),g.promise},this.processCommand=function(a){var b,d=this,e=c.defer();return e.resolve(),e.promise.then(function(){return d.intercept("Before",a.command.interceptors)}).then(function(){var e=c.defer();try{if(!a.command.interceptors)return t(),void e.resolve();if(a.command.interceptors.Around)b=d.intercept("Around",a.command.interceptors,a.command.commandFunction);else{var f=d.instantiate(a.command.commandFunction,!0);b=d.invoke(f.execute,f)}d.processResults(b,a.command.config).then(function(){e.resolve()},function(a){e.reject(a)})}catch(g){e.reject(g)}return e.promise}).then(function(){return d.intercept("AfterExecution",a.command.interceptors)}).then(function(){return b=d.exeOnResult(d.contextData.lastResult),d.processResults(b,a.command.config)}).then(function(){return d.intercept("After",a.command.interceptors)},function(b){var e=c.defer();return d.canceled?(e.reject(b),e.promise):(d.exeOnError(b),d.getContextData().lastError=b,d.intercept("AfterThrowing",a.command.interceptors).then(function(){e.reject(b)},function(){e.reject(b)}),e.promise)})},this.intercept=function(a,d,e){var f=this,i=c.defer();if(!d[a])return i.resolve(),i.promise;switch(d[a].sort(function(a,b){return b.order-a.order}),a){case"Around":var j=new h(e,null,f,i,c);b.forEach(d[a],function(a){j=new h(a.func,j,f,i,c)}),c.when(j.invoke()).then(function(a){i.resolve(a)},function(a){i.reject(a)});break;default:var j=this.contextData.processor=new g(f,i);d[a].reverse();var k=0;!function l(){try{if(k===d[a].length||f.canceled)return void i.resolve();var b=f.instantiate(d[a][k++].func,!1);c.when(f.invoke(b.execute,b)).then(function(){l()},function(a){})}catch(e){i.reject(e)}}()}return i.promise},this.instantiate=function(a,b){var c=d.instantiate(a,this.contextData);return b&&(this.currentCommandInstance=c),c},this.exeOnResult=function(a){return this.currentCommandInstance&&this.currentCommandInstance.hasOwnProperty("onResult")?this.currentCommandInstance.onResult(a):void 0},this.exeOnError=function(a){this.currentCommandInstance&&this.currentCommandInstance.hasOwnProperty("onError")&&this.currentCommandInstance.onError(a)},this.processResults=function(a,b){var d=this,e=c.defer();if(!a)return e.resolve(),e.promise;c.when(a).then(function(a){d.contextData.lastResult=a,b&&b.resultKey&&(d.contextData[b.resultKey]=a),e.resolve()},function(a){e.reject(a)});return e.promise},this.invoke=function(a,b){return d.invoke(a,b,this.contextData)},this.getContextData=function(a){return this.contextData}}function g(a,b){this.deferred=b,this.context=a}function h(a,b,c,d,e){g.apply(this,[c,d]),this.executed=a,this.next=b,this.$q=e}var i=a.commangular||(a.commangular={}),j={},k="",l="",m=[],n=[],o={},p={},q=/\/(.*)\//,r=/@([^(]*)\((.*)\)/,s=!1,t=function(){console.warn("An event was dispatched that has no command mapped to it.")},u={},v={};i.inject=function(a,b,c){u[b]||(u[b]=[]),u[b].push({scope:a,target:c}),a[c]=v[b]},i.getInjectionsByName=function(a){return u[a]},i.doInjection=function(a,b){_.each(i.getInjectionsByName(a),function(a){a.scope[a.target]=b})},i.registerInjectionSource=function(a,b){v[a]=b,i.doInjection(a,b)};var w={};i.create=function(a,b,c){if(void 0===a&&console.warn("Warning: creating a command with an undefined name. Should be fixed!\ncommand: "+JSON.stringify(b)+"\nAdd a breakpoint to this line and find the problem in the stack trace."),w[a]===!0)throw'Error: commandName: "'+a+'" was already created. You should not create this command again. Fix this!';w[a]=!0,j[a]={commandFunction:b,config:c,interceptors:{},commandName:a},k=k.concat("%"+a+"%{"+a+"}\n")},i.command=i.create,i.aspect=function(a,b,c){var d=r.exec(a),e=d[1],f=q.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg"),h=c||(c=0);if(!/(\bBefore\b|\bAfterExecution\b|\bAfter\b|\bAfterThrowing\b|\bAround\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");m.push({poincut:e,matcher:g,aspectFunction:b,order:h,descriptor:a})},i.eventAspect=function(a,b,c){var d=r.exec(a),e=d[1],f=q.exec(d[2])[1],g=new RegExp("^%"+f+"%{(.*)}$","mg"),h=c||(c=0);if(!/(\bBefore\b|\bAfter\b|\bAfterThrowing\b)/.test(e))throw new Error("aspect descriptor "+a+" contains errors");n.push({poincut:e,matcher:g,aspectFunction:b,order:h,descriptor:a})},i.resolver=function(a,b){var c=["lastResult","processor","$injector",function(c,d,e){return{execute:function(){var f=e.invoke(b,this,{result:c});return d.setData("lastResult",f),j[a]&&j[a].config&&j[a].config.resultKey&&d.setData(j[a].config.resultKey,f),f}}}],e="@AfterExecution(/"+d(a)+"/)";i.aspect(e,c,-100)},i.reset=function(){m=n=[],j=p={},k=l=""},i.debug=function(a){s=a},i.build=function(){!function a(c,d,e){return b.forEach(c,function(a){for(var b;null!=(b=a.matcher.exec(d));)e[b[1]].interceptors?(e[b[1]].interceptors[a.poincut]||(e[b[1]].interceptors[a.poincut]=[]),e[b[1]].interceptors[a.poincut].push({func:a.aspectFunction,order:a.order})):t()}),a}(m,k,j)(n,l,p)},e.prototype.asSequence=function(){return this.ctype="S",this},e.prototype.asParallel=function(){return this.ctype="P",this},e.prototype.asFlow=function(){return this.ctype="F",this},e.prototype.add=function(a){return this.descriptors.push(b.isString(a)?new e("E",j[a]):a),this},e.prototype.link=function(a,b){return this.descriptors.push({expresion:a,services:b}),this},e.prototype.to=function(a){return this.descriptors[this.descriptors.length-1].commandDescriptor=b.isString(a)?new e("E",j[a]):a,this},g.prototype.cancel=function(a){this.context.canceled=!0,this.deferred.reject(a)},g.prototype.setData=function(a,b){this.context.contextData[a]=b},g.prototype.getData=function(a){return this.context.contextData[a]},h.prototype=new g,h.prototype.constructor=h,h.prototype.invoke=function(){this.context.contextData.processor=this.next;var a=this.context.instantiate(this.executed,null==this.next);return this.$q.when(this.context.invoke(a.execute,a))},b.module("commangular",[]).provider("$commangular",function(){return{$get:["commandExecutor",function(a){return{dispatch:function(b,c){return a.execute(b,c)}}}],mapTo:function(a){var b=p[a]||(p[a]={});return b.interceptors||(b.interceptors={}),l=l.concat("%"+a+"%{"+a+"}\n"),o[a]=new e,o[a]},asSequence:function(){return new e("S")},asParallel:function(){return new e("P")},asFlow:function(){return new e("F")},findCommand:function(a){return o[a]}}}),b.module("commangular").service("commandExecutor",["$q","$injector","$parse","$exceptionHandler",function(a,b,c,d){return{execute:function(b,c){var e=this,f=a.defer(),g=e.createContext(c),h=o[b],i=p[b].interceptors;return f.resolve(),f.promise.then(function(){return g.intercept("Before",i)}).then(function(){return g.processDescriptor(h)}).then(function(){return g.intercept("After",i)}).then(function(){return e.returnData(g)},function(b){s&&d(b);var c=a.defer();return g.intercept("AfterThrowing",i).then(function(){c.reject(b)},function(){f.reject(b)}),c.promise})},createContext:function(d){return new f(d,a,b,c)},returnData:function(a){return a.contextData}}}]),b.module("commangular").run(i.build),b.module("commangular").config(["$provide",function(a){a.decorator("$rootScope",["$injector","$delegate",function(a,b){return b.dispatch=function(b,c){return a.get("commandExecutor").execute(b,c)},b}])}])}(window,window.angular);